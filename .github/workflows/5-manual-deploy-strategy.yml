name: Manual Deployment Controller
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
          - development
      version:
        description: 'Version or tag to deploy (e.g., v1.2.3)'
        required: true
        default: 'latest'
        type: string
      skip_tests:
        description: 'Skip testing phase (use with caution)'
        required: false
        default: false
        type: boolean
      strategy:
        description: 'Deployment strategy'
        required: true
        default: 'rolling'
        type: choice
        options:
          - rolling
          - blue-green
          - canary
      notification_channel:
        description: 'Slack channel for notifications (optional)'
        required: false
        default: '#deployments'
        type: string

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Display Input Summary
        run: |
          echo "=== Deployment Summary ==="
          echo "ğŸ¯ Target Environment: ${{ github.event.inputs.environment }}"
          echo "ğŸ“¦ Version: ${{ github.event.inputs.version }}"
          echo "ğŸ§ª Skip Tests: ${{ github.event.inputs.skip_tests }}"
          echo "ğŸš€ Strategy: ${{ github.event.inputs.strategy }}"
          echo "ğŸ“¢ Notification Channel: ${{ github.event.inputs.notification_channel }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "â° Deployment Time: $(date)"

      - name: Production Environment Validation
        if: github.event.inputs.environment == 'production'
        run: |
          echo "âš ï¸  PRODUCTION DEPLOYMENT WARNING âš ï¸"
          echo "You are about to deploy to PRODUCTION environment"
          echo "Please ensure:"
          echo "- Code has been thoroughly tested"
          echo "- Stakeholders have been notified"
          echo "- Rollback plan is ready"

      - name: Staging Environment Validation
        if: github.event.inputs.environment == 'staging'
        run: |
          echo "â„¹ï¸  STAGING DEPLOYMENT INFO"
          echo "Deploying to staging environment for testing"
          echo "This deployment will be available for QA validation"

      - name: Development Environment Validation
        if: github.event.inputs.environment == 'development'
        run: |
          echo "ğŸ› ï¸  DEVELOPMENT DEPLOYMENT DEBUG"
          echo "Deploying to development environment"
          echo "This is for development and testing purposes"

      - name: Version Validation
        run: |
          echo "=== Version Validation ==="
          echo "Deploying version: ${{ github.event.inputs.version }}"
          if [[ "${{ github.event.inputs.version }}" == "latest" ]]; then
            echo "âš ï¸  Using latest version - consider using specific version tags"
          else
            echo "âœ… Using specific version: ${{ github.event.inputs.version }}"
          fi

  deploy:
    needs: validate-inputs
    runs-on: ubuntu-latest
    steps:
      - name: Pre-deployment Checks
        run: |
          echo "=== Pre-deployment Checks ==="
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Strategy: ${{ github.event.inputs.strategy }}"
          echo "Tests will be skipped: ${{ github.event.inputs.skip_tests }}"

      - name: Run Tests
        if: github.event.inputs.skip_tests == 'false'
        run: |
          echo "ğŸ§ª Running tests for version ${{ github.event.inputs.version }}..."
          echo "Running unit tests..."
          sleep 2
          echo "Running integration tests..."
          sleep 2
          echo "âœ… All tests passed!"

      - name: Production Deployment
        if: github.event.inputs.environment == 'production'
        run: |
          echo "ğŸš€ PRODUCTION DEPLOYMENT STARTING"
          echo "Environment: Production"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Strategy: ${{ github.event.inputs.strategy }}"
          echo "Implementing additional production safeguards..."
          echo "âœ… Production deployment completed successfully"

      - name: Staging Deployment
        if: github.event.inputs.environment == 'staging'
        run: |
          echo "ğŸš€ STAGING DEPLOYMENT STARTING"
          echo "Environment: Staging"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Strategy: ${{ github.event.inputs.strategy }}"
          echo "Deploying to staging servers..."
          echo "âœ… Staging deployment completed successfully"

      - name: Development Deployment
        if: github.event.inputs.environment == 'development'
        run: |
          echo "ğŸš€ DEVELOPMENT DEPLOYMENT STARTING"
          echo "Environment: Development"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Strategy: ${{ github.event.inputs.strategy }}"
          echo "Deploying to development servers..."
          echo "âœ… Development deployment completed successfully"

      - name: Strategy-Based Deployment Details
        run: |
          echo "=== Deploying with ${{ github.event.inputs.strategy }} strategy ==="
          case "${{ github.event.inputs.strategy }}" in
            "rolling")
              echo "ğŸ”„ Rolling deployment: Gradually updating instances"
              echo "- Zero downtime deployment"
              echo "- Instances updated one by one"
              ;;
            "blue-green")
              echo "ğŸ”µğŸŸ¢ Blue-Green deployment: Switching traffic"
              echo "- New version deployed to green environment"
              echo "- Traffic switched from blue to green"
              ;;
            "canary")
              echo "ğŸ¤ Canary deployment: Gradual traffic shift"
              echo "- Small percentage of traffic to new version"
              echo "- Monitoring metrics before full rollout"
              ;;
          esac

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()  # Run even if deployment fails
    steps:
      - name: Deployment Status Check
        run: |
          echo "=== Deployment Status ==="
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Version: ${{ github.event.inputs.version }}"
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "Status: âœ… SUCCESS"
          else
            echo "Status: âŒ FAILED"
          fi

      - name: Success Notification
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ DEPLOYMENT SUCCESS NOTIFICATION"
          echo "âœ… Successfully deployed ${{ github.event.inputs.version }} to ${{ github.event.inputs.environment }}"
          echo "ğŸš€ Strategy used: ${{ github.event.inputs.strategy }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "â° Completed at: $(date)"

      - name: Failure Notification
        if: needs.deploy.result != 'success'
        run: |
          echo "ğŸš¨ DEPLOYMENT FAILURE NOTIFICATION"
          echo "âŒ Failed to deploy ${{ github.event.inputs.version }} to ${{ github.event.inputs.environment }}"
          echo "ğŸ” Please check the deployment logs for details"
          echo "ğŸ“‹ Troubleshooting steps:"
          echo "  1. Review the deployment logs above"
          echo "  2. Check application health endpoints"
          echo "  3. Consider rollback if necessary"
          echo "  4. Contact the development team"

      - name: Send Channel Notification
        run: |
          echo "ğŸ“¢ Sending notification to: ${{ github.event.inputs.notification_channel }}"
          echo "ğŸ”— Deployment details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ğŸ“Š Workflow summary available in GitHub Actions"